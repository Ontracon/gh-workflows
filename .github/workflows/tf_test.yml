on:
  workflow_call:
    inputs:
      deployment:
        required: false
        type: string
        default: 'false'
    secrets:
      token:
        required: false

jobs:
  tf_base:
    name: Base check
    runs-on: [Linux]
    outputs:
      files: ${{ steps.files.outputs.files }}
      dirs: ${{ steps.files.outputs.dirs }}
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Terraform fmt_check
        uses: otc-code/gh-actions/terraform@main
        with:
          TF_DIR: '${{ github.workspace }}'
          TERRAFORM_ACTION: 'fmt_check'

      - name: Terraform init
        uses: otc-code/gh-actions/terraform@main
        with:
          TF_DIR: '${{ github.workspace }}'
          TERRAFORM_ACTION: 'init_without_backend'
          GITHUB_TOKEN: ${{ secrets.ORG_TOKEN }}

      - name: Terraform validate
        uses: otc-code/gh-actions/terraform@main
        with:
          TF_DIR: '${{ github.workspace }}'
          TERRAFORM_ACTION: 'validate'


  tf_security:
    name: Security check
    needs: tf_base
    runs-on: [Linux]
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}      
      - name: IaC security (KICS)
        uses: checkmarx/kics-github-action@v1.6.3
        with:
          path: ${{ github.workspace }}
          #ignore_on_exit: results
          disable_secrets: true
          fail_on: 'high,medium'
          #output_path: '${{ github.workspace }}/results.sarif'
          enable_comments: true
          cloud_provider: 'aws, azure, gcp'
          token: ${{ secrets.GITHUB_TOKEN }}
          exclude_paths: './.terraform/**' # Don't test modules
          #exclude_queries: 'ef0b316a-211e-42f1-888e-64efe172b755,96ed3526-0179-4c73-b1b2-372fde2e0d13,96ed3526-0179-4c73-b1b2-372fde2e0d13,fd632aaf-b8a1-424d-a4d1-0de22fd3247a'
